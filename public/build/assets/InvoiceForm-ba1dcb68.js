import{d as D,f as U,e as j,u as z,g as o,x as Q,Q as v,o as l,R as $,w as h,m as S,t as _,i as c,b as u,c as I,a as g,n as V,k as m,h as W,_ as q,a5 as G,$ as H,a0 as P}from"./main-cee2eb24.js";import{s as B}from"./multiselect-97a39018.js";import{_ as J,u as K}from"./Invoice.vue_vue_type_script_setup_true_lang-58160e80.js";import{F as d}from"./formMode-f60a729f.js";import{I as E}from"./invoiceStatus-af715b0d.js";import"./CurrencyInput.vue_vue_type_script_setup_true_lang-8eeeffea.js";import"./toggle-afba85dd.js";import"./itemType-8f96b3f7.js";import"./orderStatus-e3a3f9a7.js";const X=["onSubmit"],Y={key:0,class:"mb-4"},Z={key:0,class:"mb-3 flex flex-wrap items-center"},ee=u("span",{class:"w-20 rounded-l border border-r-0 border-gray-300 bg-gray-100 p-2"},"Branch",-1),ae={key:0,class:"ml-20 w-full text-sm text-red-500"},te={class:"flex flex-wrap items-center"},se=u("span",{class:"w-20 rounded-l border border-r-0 border-gray-300 bg-gray-100 p-2"},"Patient",-1),oe={key:0,class:"ml-20 w-full text-sm text-red-500"},re=["disabled"],fe=D({__name:"InvoiceForm",emits:["close"],setup(ne,{emit:N}){const w=U(),O=j(),p=z().user.branches,F=K(),e=o({discount:0,extraCharges:0,status:E.Closed}),r=o([]),b=o({amount:0,notes:""}),x=o({}),n=o(d.Create),f=o(!1),t=o({});Q(()=>{w.path.endsWith("/edit")&&(n.value=d.Edit,M(w.params.id)),p.length===1&&n.value===d.Create&&(e.value.branchId=p[0].id,y())});const L=async s=>{if(!e.value.branchId)return;const{data:a}=await v.get(`/api/patients/list?branchId=${e.value.branchId}&name=${s}&limit=15`);return a.data},M=async s=>{const{data:a}=await v.get(`/api/invoices/${s}`);e.value=a.data,r.value=a.data.invoiceItems,b.value.amount=a.data.paidAmount,y()},y=async()=>{const{data:s}=await v.get(`/api/price-lists/eligible?branchId=${e.value.branchId}&centerId=${e.value.visit?.centerId??""}&labId=${e.value.visit?.labId??""}&doctorId=${e.value.visit?.doctorId??""}`);x.value=s.data},R=async()=>{f.value=!0;try{F.total(e.value,r.value)<0?H.fire({icon:"error",title:"Invoice can't have negative total."}):n.value===d.Create?await T():await A()}catch(s){t.value=s.response.data.errors??{}}f.value=!1},T=async()=>{await v.post("/api/invoices",{invoice:e.value,invoiceItems:r.value,payment:b.value}),P.fire(),C()},A=async()=>{await v.patch(`/api/invoices/${e.value.id}`,{invoice:e.value,invoiceItems:r.value}),P.fire(),k()},C=()=>{e.value={branchId:e.value.branchId,discount:0,extraCharges:0,status:E.Closed},r.value=[],b.value={amount:0,notes:""},t.value={}},k=()=>{N("close"),O.back()};return(s,a)=>(l(),$(G,{"modal-class":"!w-[60rem]"},{header:h(()=>[S(_(n.value===c(d).Create?"Create New Invoice":"Edit Invoice"),1)]),body:h(()=>[u("form",{id:"form",onSubmit:W(R,["prevent","stop"])},[n.value!==c(d).Edit?(l(),I("div",Y,[c(p).length>1?(l(),I("div",Z,[ee,g(c(B),{modelValue:e.value.branchId,"onUpdate:modelValue":a[0]||(a[0]=i=>e.value.branchId=i),options:c(p),searchable:!0,"value-prop":"id","track-by":"name",label:"name","can-deselect":!1,"can-clear":!1,onSelect:y,onChange:C,class:V(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("branchId")}])},null,8,["modelValue","options","class"]),t.value.hasOwnProperty("branchId")?(l(),I("p",ae,_(t.value.branchId[0]),1)):m("",!0)])):m("",!0),u("div",te,[se,g(c(B),{modelValue:e.value.patient,"onUpdate:modelValue":a[1]||(a[1]=i=>e.value.patient=i),options:L,"filter-results":!1,"resolve-on-load":!1,"min-chars":1,delay:500,object:!0,"value-prop":"id","track-by":"name",label:"name",searchable:!0,canClear:!1,onSelect:a[2]||(a[2]=i=>e.value.patientId=i.id),onDeselect:a[3]||(a[3]=i=>e.value.patientId=null),class:V(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("invoice.patientId")}])},null,8,["modelValue","class"]),t.value.hasOwnProperty("invoice.patientId")?(l(),I("p",oe,_(t.value["invoice.patientId"][0]),1)):m("",!0)])])):m("",!0),e.value.branchId?(l(),$(J,{key:1,"branch-id":e.value.branchId,"price-list":x.value,invoice:e.value,"invoice-items":r.value,payment:b.value,errors:t.value,mode:n.value},null,8,["branch-id","price-list","invoice","invoice-items","payment","errors","mode"])):m("",!0)],40,X)]),footer:h(()=>[u("button",{class:"mr-2 btn-blue",disabled:f.value,form:"form"},[g(q,{"is-loading":f.value},{default:h(()=>[S("Save")]),_:1},8,["is-loading"])],8,re),u("button",{onClick:k,class:"btn-gray"},"Cancel")]),_:1}))}});export{fe as default};
