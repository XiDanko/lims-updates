import{d as R,u as U,e as o,x as j,A as u,o as i,C as S,w as h,k as V,t as _,g as l,b as c,c as y,a as g,n as $,i as v,f as z,_ as W,V as q,m as G,l as H,T as J,S as P}from"./main-c1f62c61.js";import{s as B}from"./multiselect-ffe70d49.js";import{_ as K,u as Q}from"./Invoice.vue_vue_type_script_setup_true_lang-6a0e73d3.js";import{F as m}from"./formMode-f60a729f.js";import{I as E}from"./invoiceStatus-af715b0d.js";import"./CurrencyInput.vue_vue_type_script_setup_true_lang-0c3f56bb.js";import"./toggle-b89396fa.js";import"./itemType-8f96b3f7.js";import"./orderStatus-e3a3f9a7.js";const X=["onSubmit"],Y={key:0,class:"mb-4"},Z={key:0,class:"flex flex-wrap items-center mb-3"},ee=c("span",{class:"w-20 p-2 border border-gray-300 border-r-0 rounded-l bg-gray-100"},"Branch",-1),ae={key:0,class:"ml-20 w-full text-red-500 text-sm"},te={class:"flex flex-wrap items-center"},se=c("span",{class:"w-20 p-2 border border-gray-300 border-r-0 rounded-l bg-gray-100"},"Patient",-1),oe={key:0,class:"ml-20 w-full text-red-500 text-sm"},re=["disabled"],fe=R({__name:"InvoiceForm",emits:["close"],setup(ne,{emit:N}){const w=G(),O=H(),p=U().user.branches,T=Q(),e=o({discount:0,extraCharges:0,status:E.Closed}),r=o([]),b=o({amount:0,notes:""}),x=o({}),d=o(m.Create),f=o(!1),t=o({});j(()=>{p.length===1&&(e.value.branchId=p[0].id,I()),w.path.endsWith("/edit")&&(d.value=m.Edit,F(w.params.id))});const A=async s=>{if(!e.value.branchId)return;const{data:a}=await u.get(`/api/patients/list?branchId=${e.value.branchId}&name=${s}`);return a.data},F=async s=>{const{data:a}=await u.get(`/api/invoices/${s}`);e.value=a.data,r.value=a.data.items,b.value.amount=a.data.paidAmount,I()},I=async()=>{const{data:s}=await u.get(`/api/get-eligible-price-list?branchId=${e.value.branchId}`);x.value=s.data},L=async()=>{f.value=!0;try{T.total(e.value,r.value)<0?J.fire({icon:"error",title:"Invoice can't have negative total."}):d.value===m.Create?await M():await D()}catch(s){t.value=s.response.data.errors??{}}f.value=!1},M=async()=>{await u.post("/api/invoices",{invoice:e.value,invoiceItems:r.value,payment:b.value}),P.fire(),C()},D=async()=>{await u.patch(`/api/invoices/${e.value.id}`,{invoice:e.value,invoiceItems:r.value}),P.fire(),k()},C=()=>{e.value={branchId:e.value.branchId,discount:0,extraCharges:0,status:E.Closed},r.value=[],b.value={amount:0,notes:""},t.value={}},k=()=>{N("close"),O.back()};return(s,a)=>(i(),S(q,{"modal-class":"!w-[60rem]"},{header:h(()=>[V(_(d.value===l(m).Create?"Create New Invoice":"Edit Invoice"),1)]),body:h(()=>[c("form",{id:"form",onSubmit:z(L,["prevent","stop"])},[d.value!==l(m).Edit?(i(),y("div",Y,[l(p).length>1?(i(),y("div",Z,[ee,g(l(B),{modelValue:e.value.branchId,"onUpdate:modelValue":a[0]||(a[0]=n=>e.value.branchId=n),options:l(p),searchable:!0,"value-prop":"id","track-by":"name",label:"name","can-deselect":!1,"can-clear":!1,onSelect:I,onChange:C,class:$(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("branchId")}])},null,8,["modelValue","options","class"]),t.value.hasOwnProperty("branchId")?(i(),y("p",ae,_(t.value.branchId[0]),1)):v("",!0)])):v("",!0),c("div",te,[se,g(l(B),{modelValue:e.value.patient,"onUpdate:modelValue":a[1]||(a[1]=n=>e.value.patient=n),options:A,"filter-results":!1,"resolve-on-load":!1,"min-chars":1,delay:500,object:!0,"value-prop":"id","track-by":"name",label:"name",searchable:!0,canClear:!1,onSelect:a[2]||(a[2]=n=>e.value.patientId=n.id),onDeselect:a[3]||(a[3]=n=>e.value.patientId=null),class:$(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("invoice.patientId")}])},null,8,["modelValue","class"]),t.value.hasOwnProperty("invoice.patientId")?(i(),y("p",oe,_(t.value["invoice.patientId"][0]),1)):v("",!0)])])):v("",!0),e.value.branchId?(i(),S(K,{key:1,"branch-id":e.value.branchId,"price-list":x.value,invoice:e.value,"invoice-items":r.value,payment:b.value,errors:t.value,mode:d.value},null,8,["branch-id","price-list","invoice","invoice-items","payment","errors","mode"])):v("",!0)],40,X)]),footer:h(()=>[c("button",{class:"btn-blue mr-2",disabled:f.value,form:"form"},[g(W,{"is-loading":f.value},{default:h(()=>[V("Save")]),_:1},8,["is-loading"])],8,re),c("button",{onClick:k,class:"btn-gray"},"Cancel")]),_:1}))}});export{fe as default};
