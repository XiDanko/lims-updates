import{d as D,u as U,e as o,x as j,Q as c,o as u,R as k,w as p,k as x,t as S,g as b,b as d,c as y,a as _,i as f,n as V,f as z,_ as Q,a4 as W,m as Z,l as q,Z as G,$ as P}from"./main-DNdNUUJ7.js";import{s as H}from"./multiselect-K4eUN8Nz.js";import{_ as J,u as K}from"./Invoice.vue_vue_type_script_setup_true_lang-CLrNTWsW.js";import{F as l}from"./formMode-Bz--3d4P.js";import{I as E}from"./invoiceStatus-DLsDzOgH.js";import{_ as X}from"./BranchSelect.vue_vue_type_script_setup_true_lang-BebEpNal.js";import"./CurrencyInput.vue_vue_type_script_setup_true_lang-B7NMAXDI.js";import"./toggle-B4ffD-ge.js";import"./itemType-B7Ja-e29.js";import"./orderStatus-Cdywi7Or.js";const Y={key:0,class:"mb-4 grid grid-cols-1 gap-4"},ee={key:0,class:"relative"},ae={class:"relative"},te={key:0,class:"text-sm text-red-500"},se=["disabled"],be=D({__name:"InvoiceForm",emits:["close"],setup(oe,{emit:N}){const B=N,g=Z(),F=q(),I=U().user.branches,L=K(),e=o({discount:0,extraCharges:0,status:E.Closed}),i=o([]),v=o({amount:0,notes:""}),C=o({}),n=o(l.Create),m=o(!1),t=o({});j(()=>{g.path.endsWith("/edit")&&(n.value=l.Edit,O(g.params.id)),I.length===1&&n.value===l.Create&&(e.value.branchId=I[0].id,h())});const M=async s=>{if(!e.value.branchId)return;const{data:a}=await c.get(`/api/patients/list?branchId=${e.value.branchId}&name=${s}&limit=15`);return a.data},O=async s=>{const{data:a}=await c.get(`/api/invoices/${s}`);e.value=a.data,i.value=a.data.invoiceItems,v.value.amount=a.data.paidAmount,h()},h=async()=>{const{data:s}=await c.get(`/api/price-lists/eligible?branchId=${e.value.branchId}&centerId=${e.value.visit?.centerId??""}&labId=${e.value.visit?.labId??""}&doctorId=${e.value.visit?.doctorId??""}`);C.value=s.data},R=async()=>{m.value=!0;try{L.total(e.value,i.value)<0?G.fire({icon:"error",title:"Invoice can't have negative total."}):n.value===l.Create?await T():await A(),t.value={}}catch(s){t.value=s.response.data.errors??{}}m.value=!1},T=async()=>{await c.post("/api/invoices",{invoice:e.value,invoiceItems:i.value,payment:v.value}),P.fire(),w()},A=async()=>{await c.patch(`/api/invoices/${e.value.id}`,{invoice:e.value,invoiceItems:i.value}),P.fire(),$()},w=()=>{e.value={branchId:e.value.branchId,discount:0,extraCharges:0,status:E.Closed},i.value=[],v.value={amount:0,notes:""},t.value={}},$=()=>{B("close"),F.back()};return(s,a)=>(u(),k(W,{"modal-class":"!w-[60rem]"},{header:p(()=>[x(S(n.value===b(l).Create?"Create New Invoice":"Edit Invoice"),1)]),body:p(()=>[d("form",{id:"form",onSubmit:z(R,["prevent","stop"])},[n.value!==b(l).Edit?(u(),y("div",Y,[b(I).length>1?(u(),y("div",ee,[_(X,{modelValue:e.value.branchId,"onUpdate:modelValue":a[0]||(a[0]=r=>e.value.branchId=r),error:t.value["invoice.branchId"],onSelect:h,onChange:w},null,8,["modelValue","error"])])):f("",!0),d("div",ae,[_(b(H),{modelValue:e.value.patient,"onUpdate:modelValue":a[1]||(a[1]=r=>e.value.patient=r),options:M,"filter-results":!1,"resolve-on-load":!1,"min-chars":1,delay:500,object:!0,"value-prop":"id","track-by":"name",label:"name",searchable:!0,canClear:!1,onSelect:a[2]||(a[2]=r=>e.value.patientId=r.id),onDeselect:a[3]||(a[3]=r=>e.value.patientId=null),class:V(["input peer",{"border-red-500":t.value.hasOwnProperty("invoice.patientId")}])},null,8,["modelValue","class"]),d("label",{class:V(["label",{"text-red-500":t.value.hasOwnProperty("invoice.patientId")}])},"Patient",2),t.value.hasOwnProperty("invoice.patientId")?(u(),y("p",te,S(t.value["invoice.patientId"][0]),1)):f("",!0)])])):f("",!0),e.value.branchId?(u(),k(J,{key:1,"branch-id":e.value.branchId,"price-list":C.value,invoice:e.value,"invoice-items":i.value,payment:v.value,errors:t.value,mode:n.value},null,8,["branch-id","price-list","invoice","invoice-items","payment","errors","mode"])):f("",!0)],32)]),footer:p(()=>[d("button",{class:"me-2 btn-blue",disabled:m.value,form:"form"},[_(Q,{"is-loading":m.value},{default:p(()=>[x("Save")]),_:1},8,["is-loading"])],8,se),d("button",{onClick:$,class:"btn-gray"},"Cancel")]),_:1}))}});export{be as default};
