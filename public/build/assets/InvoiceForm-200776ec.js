import{d as D,f as U,e as j,u as z,g as o,x as Q,Q as u,o as i,R as $,w as h,m as S,t as _,i as l,b as c,c as I,a as g,n as V,k as v,h as W,_ as q,a5 as G,$ as H,a0 as P}from"./main-0c5e983d.js";import{s as B}from"./multiselect-f0516a60.js";import{_ as J,u as K}from"./Invoice.vue_vue_type_script_setup_true_lang-244477e6.js";import{F as m}from"./formMode-f60a729f.js";import{I as E}from"./invoiceStatus-af715b0d.js";import"./CurrencyInput.vue_vue_type_script_setup_true_lang-3e5c15d0.js";import"./toggle-f29ee038.js";import"./itemType-8f96b3f7.js";import"./orderStatus-e3a3f9a7.js";const X=["onSubmit"],Y={key:0,class:"mb-4"},Z={key:0,class:"mb-3 flex flex-wrap items-center"},ee=c("span",{class:"w-20 rounded-l border border-r-0 border-gray-300 bg-gray-100 p-2"},"Branch",-1),ae={key:0,class:"ml-20 w-full text-sm text-red-500"},te={class:"flex flex-wrap items-center"},se=c("span",{class:"w-20 rounded-l border border-r-0 border-gray-300 bg-gray-100 p-2"},"Patient",-1),oe={key:0,class:"ml-20 w-full text-sm text-red-500"},re=["disabled"],fe=D({__name:"InvoiceForm",emits:["close"],setup(ne,{emit:N}){const w=U(),O=j(),p=z().user.branches,F=K(),e=o({discount:0,extraCharges:0,status:E.Closed}),r=o([]),b=o({amount:0,notes:""}),x=o({}),d=o(m.Create),f=o(!1),t=o({});Q(()=>{p.length===1&&(e.value.branchId=p[0].id,y()),w.path.endsWith("/edit")&&(d.value=m.Edit,M(w.params.id))});const L=async s=>{if(!e.value.branchId)return;const{data:a}=await u.get(`/api/patients/list?branchId=${e.value.branchId}&name=${s}&limit=15`);return a.data},M=async s=>{const{data:a}=await u.get(`/api/invoices/${s}`);e.value=a.data,r.value=a.data.invoiceItems,b.value.amount=a.data.paidAmount,y()},y=async()=>{const{data:s}=await u.get(`/api/get-eligible-price-list?branchId=${e.value.branchId}&centerId=${e.value.visit?.centerId??""}&labId=${e.value.visit?.labId??""}&doctorId=${e.value.visit?.doctorId??""}`);x.value=s.data},R=async()=>{f.value=!0;try{F.total(e.value,r.value)<0?H.fire({icon:"error",title:"Invoice can't have negative total."}):d.value===m.Create?await T():await A()}catch(s){t.value=s.response.data.errors??{}}f.value=!1},T=async()=>{await u.post("/api/invoices",{invoice:e.value,invoiceItems:r.value,payment:b.value}),P.fire(),C()},A=async()=>{await u.patch(`/api/invoices/${e.value.id}`,{invoice:e.value,invoiceItems:r.value}),P.fire(),k()},C=()=>{e.value={branchId:e.value.branchId,discount:0,extraCharges:0,status:E.Closed},r.value=[],b.value={amount:0,notes:""},t.value={}},k=()=>{N("close"),O.back()};return(s,a)=>(i(),$(G,{"modal-class":"!w-[60rem]"},{header:h(()=>[S(_(d.value===l(m).Create?"Create New Invoice":"Edit Invoice"),1)]),body:h(()=>[c("form",{id:"form",onSubmit:W(R,["prevent","stop"])},[d.value!==l(m).Edit?(i(),I("div",Y,[l(p).length>1?(i(),I("div",Z,[ee,g(l(B),{modelValue:e.value.branchId,"onUpdate:modelValue":a[0]||(a[0]=n=>e.value.branchId=n),options:l(p),searchable:!0,"value-prop":"id","track-by":"name",label:"name","can-deselect":!1,"can-clear":!1,onSelect:y,onChange:C,class:V(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("branchId")}])},null,8,["modelValue","options","class"]),t.value.hasOwnProperty("branchId")?(i(),I("p",ae,_(t.value.branchId[0]),1)):v("",!0)])):v("",!0),c("div",te,[se,g(l(B),{modelValue:e.value.patient,"onUpdate:modelValue":a[1]||(a[1]=n=>e.value.patient=n),options:L,"filter-results":!1,"resolve-on-load":!1,"min-chars":1,delay:500,object:!0,"value-prop":"id","track-by":"name",label:"name",searchable:!0,canClear:!1,onSelect:a[2]||(a[2]=n=>e.value.patientId=n.id),onDeselect:a[3]||(a[3]=n=>e.value.patientId=null),class:V(["flex-1 border border-gray-300 !rounded-r",{"!border-red-500":t.value.hasOwnProperty("invoice.patientId")}])},null,8,["modelValue","class"]),t.value.hasOwnProperty("invoice.patientId")?(i(),I("p",oe,_(t.value["invoice.patientId"][0]),1)):v("",!0)])])):v("",!0),e.value.branchId?(i(),$(J,{key:1,"branch-id":e.value.branchId,"price-list":x.value,invoice:e.value,"invoice-items":r.value,payment:b.value,errors:t.value,mode:d.value},null,8,["branch-id","price-list","invoice","invoice-items","payment","errors","mode"])):v("",!0)],40,X)]),footer:h(()=>[c("button",{class:"mr-2 btn-blue",disabled:f.value,form:"form"},[g(q,{"is-loading":f.value},{default:h(()=>[S("Save")]),_:1},8,["is-loading"])],8,re),c("button",{onClick:k,class:"btn-gray"},"Cancel")]),_:1}))}});export{fe as default};
